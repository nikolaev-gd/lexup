# Карта компонентов системы LexUp

Этот документ описывает основные компоненты системы LexUp, их взаимосвязи и детали реализации.

## Основные компоненты

### 1. MyApp
- **Путь к файлу:** lib/main.dart
- **Описание:** Корневой виджет приложения
- **Основные параметры:**
  - `title` (String): Название приложения
  - `theme` (ThemeData): Тема приложения
- **Ключевые методы:**
  - `build(BuildContext context)`: Создает и возвращает MaterialApp
- **Статус:** Готов
- **Известные проблемы:** Нет
- **Планируемые улучшения:** Добавление поддержки темной темы

### 2. AuthGate
- **Путь к файлу:** lib/main.dart
- **Описание:** Управляет аутентификацией пользователя
- **Основные параметры:**
  - `_isLoading` (bool): Состояние загрузки
  - `_hasError` (bool): Наличие ошибки при входе
- **Ключевые методы:**
  - `build(BuildContext context)`: Возвращает либо индикатор загрузки, сообщение об ошибке, либо HomePage
  - `_autoSignIn()`: Выполняет автоматический вход с предустановленными учетными данными
- **Статус:** Обновлен
- **Известные проблемы:** Время запуска ~23 секунды
- **Планируемые улучшения:** 
  - Оптимизация времени запуска
  - Возврат к стандартному режиму аутентификации после разработки

### 3. HomePage
- **Путь к файлу:** lib/main.dart
- **Описание:** Основной экран приложения после входа пользователя
- **Основные параметры:** Нет
- **Ключевые методы:**
  - `build(BuildContext context)`: Создает Scaffold с BottomNavigationBar
  - `_buildBody()`: Возвращает соответствующий виджет в зависимости от выбранного индекса
- **Статус:** Готов
- **Известные проблемы:** Нет
- **Планируемые улучшения:** Добавление новых разделов в навигацию

### 4. HomeContent
- **Путь к файлу:** lib/main.dart
- **Описание:** Отображает список добавленного пользователем контента
- **Основные параметры:** Нет
- **Ключевые методы:**
  - `build(BuildContext context)`: Создает StreamBuilder для отображения списка контента
- **Статус:** Готов
- **Известные проблемы:** Возможны проблемы с производительностью при большом количестве контента
- **Планируемые улучшения:** Реализация пагинации или виртуального скроллинга

### 5. AddContentScreen
- **Путь к файлу:** lib/add_content_screen.dart
- **Описание:** Экран для добавления нового контента
- **Основные параметры:** Нет
- **Ключевые методы:**
  - `build(BuildContext context)`: Создает форму для ввода текста и ссылки
  - `_saveContent()`: Сохраняет введенный контент в Firestore
- **Статус:** Готов
- **Известные проблемы:** Нет валидации ссылок
- **Планируемые улучшения:** Добавление предпросмотра контента перед сохранением

### 6. FullTextScreen
- **Путь к файлу:** lib/screens/full_text_screen.dart
- **Описание:** Отображает полный текст выбранного контента
- **Основные параметры:**
  - `text` (String): Полный текст контента
  - `link` (String): Ссылка на контент
  - `title` (String): Заголовок контента
  - `documentId` (String): ID документа в Firestore
- **Ключевые методы:**
  - `build(BuildContext context)`: Создает экран с полным текстом и функциями
  - `_simplifyText()`: Упрощает текст с использованием AI
  - `_showWordInfo(String word, String sentence)`: Показывает информацию о выбранном слове в попапе
  - `_buildWordSpans(String phrase, String word)`: Форматирует текст с выделением слова
  - `_cleanWord(String word)`: Очищает слово от пунктуации для поиска
- **Особенности обработки текста:**
  - Интеллектуальный поиск слов в тексте с учетом пунктуации
  - Поддержка многословных выражений
  - Сохранение оригинального форматирования
- **Особенности отображения попапа:**
  - Использует RichText для комбинированного отображения заголовка
  - Поддерживает слова с пунктуацией и многословные выражения
  - Корректно выделяет слова в любой позиции фразы
  - Определение выделено курсивом и синим цветом
  - Структурированное отображение информации с отступами
- **Статус:** Обновлен
- **Известные проблемы:** Высокая нагрузка на API при частом использовании функции упрощения
- **Планируемые улучшения:** 
  - Кэширование результатов упрощения текста
  - Добавление функции озвучивания текста

### 7. ContentCard
- **Путь к файлу:** lib/widgets/content_card.dart
- **Описание:** Виджет для отображения краткой информации о контенте
- **Основные параметры:**
  - `text` (String): Текст контента
  - `link` (String): Ссылка на контент
  - `onTap` (Function): Обработчик нажатия на карточку
  - `onDelete` (Function): Обработчик удаления карточки
- **Ключевые методы:**
  - `build(BuildContext context)`: Создает карточку с информацией о контенте
- **Статус:** Готов
- **Известные проблемы:** Нет
- **Планируемые улучшения:** Добавление возможности редактирования контента

### 8. ClickableText
- **Путь к файлу:** lib/widgets/clickable_text.dart
- **Описание:** Виджет для отображения интерактивного текста
- **Основные параметры:**
  - `text` (String): Отображаемый текст
  - `fontSize` (double): Размер шрифта
  - `onWordTap` (Function): Обработчик нажатия на слово
- **Ключевые методы:**
  - `build(BuildContext context)`: Создает интерактивный текст
- **Статус:** Готов
- **Известные проблемы:** Возможны проблемы с производительностью на длинных текстах
- **Планируемые улучшения:** Оптимизация рендеринга для длинных текстов

### 9. SavedCards
- **Путь к файлу:** lib/widgets/saved_cards.dart
- **Описание:** Виджет для отображения сохраненных карточек слов
- **Основные параметры:**
  - `cardStream` (Stream<QuerySnapshot>): Поток данных с сохраненными карточками
  - `onDeleteCard` (Function): Обработчик удаления карточки
- **Ключевые методы:**
  - `build(BuildContext context)`: Создает список сохраненных карточек
  - `_buildWordSpans(String phrase, String word)`: Форматирует текст с выделением слова
  - `_cleanWord(String word)`: Очищает слово от пунктуации для поиска
- **Особенности обработки текста:**
  - Интеллектуальный поиск слов с учетом пунктуации
  - Поддержка многословных выражений
  - Сохранение оригинального форматирования
  - Корректная обработка слов в любой позиции фразы
- **Особенности отображения:**
  - Использует RichText для комбинированного отображения заголовка
  - Поддерживает слова с пунктуацией (например, "all).")
  - Корректно обрабатывает многословные выражения (например, "no work at all")
  - Размер шрифта заголовка: 18px
  - Определение выделено курсивом и синим цветом
  - Использует Expanded для корректного отображения длинных фраз
  - Структурированное отображение информации с отступами
- **Структура карточки:**
  - Заголовок (extractedPhrase с выделенным word)
  - Оригинальное предложение
  - Краткое определение (стилизовано)
  - Распространенные словосочетания
  - Пример предложения
- **Статус:** Обновлен
- **Известные проблемы:** Нет
- **Планируемые улучшения:** 
  - Добавление функции редактирования карточек
  - Улучшение адаптивности для разных размеров экрана

## Сервисы

### 1. ApiService
- **Путь к файлу:** lib/services/api_service.dart
- **Описание:** Отвечает за взаимодействие с внешними API
- **Основные методы:**
  - `simplifyText(String text)`: Упрощает текст с использованием AI
  - `getWordInfo(String word, String sentence)`: Получает информацию о слове
- **Статус:** Готов, активно используется
- **Известные проблемы:** Зависимость от стабильности внешнего API
- **Планируемые улучшения:** 
  - Реализация кэширования запросов
  - Добавление обработки ошибок и повторных попыток

### 2. FirestoreService
- **Путь к файлу:** lib/services/firestore_service.dart
- **Описание:** Управляет взаимодействием с Firestore
- **Основные методы:**
  - `saveContent(String userId, Map<String, dynamic> content)`: Сохраняет новый контент
  - `getContentStream(String userId)`: Возвращает поток данных с контентом пользователя
  - `deleteContent(String userId, String contentId)`: Удаляет контент
- **Статус:** Готов, активно используется
- **Известные проблемы:** Нет
- **Планируемые улучшения:** 
  - Добавление пакетных операций для оптимизации производительности
  - Реализация кэширования данных на устройстве

## Модели данных

### 1. CardModel
- **Путь к файлу:** lib/models/card_model.dart
- **Описание:** Представляет структуру данных для карточки слова
- **Основные поля:**
  - `word` (String): Изучаемое слово
  - `extractedPhrase` (String): Извлеченная фраза, содержащая слово
  - `originalSentence` (String): Оригинальное предложение
  - `briefDefinition` (String): Краткое определение
  - `commonCollocations` (String): Распространенные словосочетания
  - `exampleSentence` (String): Пример предложения
- **Ключевые методы:**
  - `fromMap(Map<String, dynamic> map)`: Создает объект из Map
  - `toMap()`: Преобразует объект в Map
- **Статус:** Готов
- **Известные проблемы:** Нет
- **Планируемые улучшения:** Добавление дополнительных полей для расширенной информации о слове

## Взаимодействие компонентов

### Потоки данных

1. Аутентификация:
   - AuthGate -> Firebase Authentication -> HomePage
   
2. Отображение контента:
   - HomeContent -> FirestoreService -> Firestore -> ContentCard

3. Добавление контента:
   - AddContentScreen -> FirestoreService -> Firestore

4. Работа с текстом:
   - FullTextScreen -> ApiService -> OpenAI API
   - FullTextScreen -> FirestoreService -> Firestore (для сохранения карточек)

### События и обработчики

- Нажатие на ContentCard в HomeContent открывает FullTextScreen
- Выбор слова в ClickableText вызывает _showWordInfo в FullTextScreen
- Нажатие кнопки "Упростить" в FullTextScreen вызывает _simplifyText

### Влияние изменений состояния

- Добавление нового контента в AddContentScreen обновляет список в HomeContent через StreamBuilder
- Сохранение новой карточки в FullTextScreen обновляет список SavedCards через StreamBuilder
- Изменение состояния аутентификации в AuthGate влияет на отображение HomePage или экрана входа

## Точки расширения

### Добавление новых функций

1. Создание новых экранов:
   - Добавьте новый файл в директорию lib/screens/
   - Создайте новый виджет, наследующийся от StatelessWidget или StatefulWidget
   - Добавьте новый пункт в нижнюю навигацию в HomePage

2. Расширение функциональности существующих экранов:
   - Добавьте новые методы в существующие классы
   - Используйте колбэки для связи с родительскими виджетами

### Модификация существующих компонентов

1. Следуйте принципу единственной ответственности:
   - Каждый компонент должен отвечать только за одну функцию
   - При необходимости разделяйте большие компоненты на меньшие

2. Используйте композицию вместо наследования:
   - Создавайте новые виджеты, комбинируя существующие

3. При добавлении новых параметров в виджеты:
   - Используйте именованные параметры
   - Предоставляйте значения по умолчанию, где это возможно

### Паттерны для соблюдения общей архитектуры

1. MVVM (Model-View-ViewModel):
   - Model: Представлен классами в lib/models/
   - View: Виджеты Flutter (экраны и компоненты)
   - ViewModel: Используйте для управления состоянием и бизнес-логикой

2. Сервис-ориентированный подход:
   - Выделяйте работу с внешними API и базами данных в отдельные сервисы
   - Размещайте сервисы в директории lib/services/

3. Управление состоянием:
   - Используйте StreamBuilder для работы с асинхронными данными
   - Рассмотрите возможность использования state management решений (например, Provider или Riverpod) для более сложных сценариев

4. Dependency Injection:
   - Используйте внедрение зависимостей для улучшения тестируемости и гибкости кода
